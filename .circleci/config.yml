version: 2.1

jobs:

  Build-DiscordCoreAPI:
    machine:
        image: ubuntu-2204:2022.04.1 # recommended linux image
    resource_class: xlarge
    steps:
      - checkout
      - run:
            name: Download and install vcpkg as well as other dependencies.
            command: sudo apt-get install nasm && 
                     sudo git clone https://github.com/Microsoft/vcpkg &&
                     cd vcpkg &&
                     sudo ./bootstrap-vcpkg.sh

      - run:
            name: Copy over the current portfile.
            command: sudo git clone https://github.com/RealTimeChris/DiscordCoreAPI &&
                     sudo cp -v -R ./DiscordCoreAPI/Vcpkg/* ./vcpkg

      - run:
            name: Download and install DiscordCoreAPI
            command: cd vcpkg &&
                     sudo ./vcpkg install discordcoreapi:x64-linux &&
                     sudo nano /home/circleci/project/vcpkg/buildtrees/discordcoreapi/install-x64-linux-dbg-out.log

  Build-Documentation:
    docker:
      - image: cimg/base:edge-22.04
    steps:
      - checkout
    
      - add_ssh_keys:
         fingerprints:
             e1:e3:0b:e4:82:48:0e:95:26:dd:aa:25:49:93:92:e7
      
      - run:
           name: Download and install Doxygen, along with its dependencies.
           command: sudo apt-get update &&
                    sudo git clone https://github.com/doxygen/doxygen &&
                    sudo apt-get install bison &&
                    sudo apt-get install flex &&
                    cd doxygen &&
                    sudo mkdir build &&
                    sudo cmake -G "Unix Makefiles" &&
                    sudo make &&
                    sudo make install &&
                    sudo apt-get install graphviz &&
                    sudo apt-get install openssh-client

      - run:
          name: Collect the original Repo for the docs.
          command: sudo git config --global user.email "40668522+RealTimeChris@users.noreply.github.com" &&
                   sudo git config --global user.name "realtimechris" &&
                   sudo git clone https://realtimechris:${PERSONAL_ACCESS_TOKEN}@github.com/realtimechris/DiscordCoreAPI-Docs --depth=1

      - run:
          name: Collect the documentation and generate it.
          command: sudo git clone https://github.com/RealTimeChris/DiscordCoreAPI --depth=1 &&
                   cd DiscordCoreAPI/Documentation/Doxygen && 
                   sudo doxygen || true

      - run:
          name: Commit and push the docs to the repo.
          command: cd DiscordCoreAPI-Docs && 
                   sudo git add . && 
                   sudo git commit -m "Updates!" && 
                   sudo git push origin main || true
                   
      - run:
           name: Store the public SSH key.
           command: echo $AWS_KEY >> PUBLIC_KEY &&
                    sudo mkdir /root/.ssh/ &&
                    sudo cp ./PUBLIC_KEY /root/.ssh/id_rsa

      - run:
          name: Clone the data over to the web server.
          command: ssh -o StrictHostKeyChecking=no ubuntu@ec2-3-144-188-157.us-east-2.compute.amazonaws.com 
                   "cd /var/www && sudo rm -rf discordcoreapi && sudo git clone https://github.com/RealTimeChris/DiscordCoreAPI-Docs --depth=1 ./discordcoreapi"
            

workflows:
  Build-DiscordCoreAPI:
    jobs:
      - Build-Documentation
      - Build-DiscordCoreAPI
