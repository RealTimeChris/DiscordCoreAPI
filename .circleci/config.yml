version: 2.1

jobs:
  Build-Documentation:
    docker:
      - image: cimg/base:edge-22.04
    steps:
      - add_ssh_keys:
          fingerprints:
            c2:79:07:18:78:47:c7:82:a2:99:9f:ad:5c:f0:0e:c5
      - add_ssh_keys:
          fingerprints:
             3e:95:52:20:45:2a:ec:bc:59:74:91:fe:d1:36:c5:bb

      - checkout 
      - run:
          name: Collect the original Repo for the docs.
          command: sudo git config --global user.email "40668522+RealTimeChris@users.noreply.github.com " && sudo git config --global user.name "realtimechris" && sudo git clone https://realtimechris:${PERSONAL_ACCESS_TOKEN}@github.com/realtimechris/DiscordCoreAPI-Docs --depth=1
      - run:
          name: Download and install Doxygen.
          command: sudo apt-get install doxygen && sudo apt install graphviz && sudo apt-get install openssh-client

      - run:
          name: Collect the documentation and generate it.
          command: sudo git clone https://github.com/RealTimeChris/DiscordCoreAPI --depth=1 && 
                    cd DiscordCoreAPI/Documentation/Doxygen && 
                    sudo doxygen

      - run:
            name: Add AWS to known hosts.
            command: sudo mkdir -p ~/.ssh
                    sudo echo 'ubuntu@ec2-18-224-43-180.us-east-2.compute.amazonaws.com ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDDCeeBzpAoDZyvr2YLyJbupnLJIOBbJbdUAo4pjWNYTmOJq4CnDYKIsoYFwuX31f2XoOXGzXT9cb9kaE1isZuXqesAsn7AZ+MbZ1CKEvNKKAMcQ1iuK7kz/H2z2e95JXwkolRv6oKciWwAGWNBMnD3d60DiXLqsmx4XJGyyvDoIuhymO5T4rUAstyIFklJ39bcse79Nn0AI2DZcB16Mr3iwSUUWo0YuOuwrNraxyhQxINgB2pc+WqG8mrEjJy+dtPNBvWD24AnDnw/6HOf8C9WFKt4ePhCXWslYRN6B6mX3lZ829wxpmCtFVeMI26Df6wOGx0Z8AKgQTywSm0jHkrwW6KqGfm+GE4oAHuEMHAKygv9ZZdgAAT5BMmbt+A29kTdGlzjvK/kk3vPdwq9l3sOnoBCaHc8LY1BbrofhHOPIMfH92F+NJ+lhSB5KLCDyS70obqR15Z6KmYnGGwAqo70T0nUF1pMCj50OgdxZEzx1UdbbyX2xSBX2lfYJlTYnjc= realtimechris@outlook.com' > ~/.ssh/known_hosts &&
                    sudo echo 'ubuntu@ec2-18-224-43-180.us-east-2.compute.amazonaws.com ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDDCeeBzpAoDZyvr2YLyJbupnLJIOBbJbdUAo4pjWNYTmOJq4CnDYKIsoYFwuX31f2XoOXGzXT9cb9kaE1isZuXqesAsn7AZ+MbZ1CKEvNKKAMcQ1iuK7kz/H2z2e95JXwkolRv6oKciWwAGWNBMnD3d60DiXLqsmx4XJGyyvDoIuhymO5T4rUAstyIFklJ39bcse79Nn0AI2DZcB16Mr3iwSUUWo0YuOuwrNraxyhQxINgB2pc+WqG8mrEjJy+dtPNBvWD24AnDnw/6HOf8C9WFKt4ePhCXWslYRN6B6mX3lZ829wxpmCtFVeMI26Df6wOGx0Z8AKgQTywSm0jHkrwW6KqGfm+GE4oAHuEMHAKygv9ZZdgAAT5BMmbt+A29kTdGlzjvK/kk3vPdwq9l3sOnoBCaHc8LY1BbrofhHOPIMfH92F+NJ+lhSB5KLCDyS70obqR15Z6KmYnGGwAqo70T0nUF1pMCj50OgdxZEzx1UdbbyX2xSBX2lfYJlTYnjc= realtimechris@outlook.com' > ~/.ssh/authorized_keys
                        

      - run:
          name: Commit and push.
          command: cd DiscordCoreAPI-Docs && 
                    sudo git add . && 
                    sudo git commit -m "Updates!" && 
                    sudo git push origin main || true
      - run:
          name: Clone the data over to the web server.
          command: sudo echo ${AWS_KEY} >TheRealKey.pem &&
                    sudo ssh -i TheRealKey.pem ubuntu@ec2-18-224-43-180.us-east-2.compute.amazonaws.com &&
                    cd /var/www &&
                    sudo rm -rf discordcoreapi &&
                    sudo git clone https://github.com/RealTimeChris/DiscordCoreAPI-Docs --depth=1 ./discordcoreapi
            
            

workflows:
  Build-DiscordCoreAPI:
    jobs:
      - Build-Documentation

